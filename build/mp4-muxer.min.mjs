var Ie=(t,e,i)=>{if(!e.has(t))throw TypeError("Cannot "+i)};var s=(t,e,i)=>(Ie(t,e,"read from private field"),i?i.call(t):e.get(t)),f=(t,e,i)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,i)},S=(t,e,i,r)=>(Ie(t,e,"write to private field"),r?r.call(t,i):e.set(t,i),i),Xe=(t,e,i,r)=>({set _(n){S(t,e,n,i)},get _(){return s(t,e,r)}}),d=(t,e,i)=>(Ie(t,e,"access private method"),i);var c=new Uint8Array(8),_=new DataView(c.buffer),k=t=>[(t%256+256)%256],T=t=>(_.setUint16(0,t,!1),[c[0],c[1]]),qe=t=>(_.setInt16(0,t,!1),[c[0],c[1]]),Me=t=>(_.setUint32(0,t,!1),[c[1],c[2],c[3]]),o=t=>(_.setUint32(0,t,!1),[c[0],c[1],c[2],c[3]]),M=t=>(_.setUint32(0,Math.floor(t/2**32),!1),_.setUint32(4,t,!1),[c[0],c[1],c[2],c[3],c[4],c[5],c[6],c[7]]),ce=t=>(_.setInt16(0,2**8*t,!1),[c[0],c[1]]),O=t=>(_.setInt32(0,2**16*t,!1),[c[0],c[1],c[2],c[3]]),Pe=t=>(_.setInt32(0,2**30*t,!1),[c[0],c[1],c[2],c[3]]),B=(t,e=!1)=>{let i=Array(t.length).fill(null).map((r,n)=>t.charCodeAt(n));return e&&i.push(0),i},D=t=>t&&t[t.length-1],E=(t,e,i=!0)=>{let r=t*e;return i?Math.round(r):r},Le=t=>{let e=t*(Math.PI/180),i=Math.cos(e),r=Math.sin(e);return[i,r,0,-r,i,0,0,0,1]},Ge=Le(0),Ve=t=>[O(t[0]),O(t[1]),Pe(t[2]),O(t[3]),O(t[4]),Pe(t[5]),O(t[6]),O(t[7]),Pe(t[8])],G=t=>!t||typeof t!="object"?t:Array.isArray(t)?t.map(G):Object.fromEntries(Object.entries(t).map(([e,i])=>[e,G(i)])),H=t=>t>=0&&t<2**32;var y=(t,e,i)=>({type:t,contents:e&&new Uint8Array(e.flat(10)),children:i}),b=(t,e,i,r,n)=>y(t,[k(e),Me(i),r??[]],n),Ke=t=>{let e=512;return t.fragmented?y("ftyp",[B("iso5"),o(e),B("iso5"),B("iso6"),B("mp41")]):y("ftyp",[B("isom"),o(e),B("isom"),t.holdsAvc?B("avc1"):[],B("mp41")])},Ce=t=>({type:"mdat",largeSize:t}),Qe=t=>({type:"free",size:t}),te=(t,e,i=!1)=>y("moov",null,[ot(e,t),...t.map(r=>lt(r,e)),i?It(t):null]),ot=(t,e)=>{let i=E(Math.max(0,...e.filter(l=>l.samples.length>0).map(l=>D(l.samples).timestamp+D(l.samples).duration)),Te),r=Math.max(...e.map(l=>l.id))+1,n=!H(t)||!H(i),a=n?M:o;return b("mvhd",+n,0,[a(t),a(t),o(Te),a(i),O(1),ce(1),Array(10).fill(0),Ve(Ge),Array(24).fill(0),o(r)])},lt=(t,e)=>y("trak",null,[ht(t,e),ut(t,e)]),ht=(t,e)=>{let i=D(t.samples),r=E(i?i.timestamp+i.duration:0,Te),n=!H(e)||!H(r),a=n?M:o;return b("tkhd",+n,3,[a(e),a(e),o(t.id),o(0),a(r),Array(8).fill(0),T(0),T(0),ce(t.info.type==="audio"?1:0),T(0),Ve(Le(t.info.type==="video"?t.info.rotation:0)),O(t.info.type==="video"?t.info.width:0),O(t.info.type==="video"?t.info.height:0)])},ut=(t,e)=>y("mdia",null,[ft(t,e),mt(t.info.type==="video"?"vide":"soun"),dt(t)]),ft=(t,e)=>{let i=D(t.samples),r=E(i?i.timestamp+i.duration:0,t.timescale),n=!H(e)||!H(r),a=n?M:o;return b("mdhd",+n,0,[a(e),a(e),o(t.timescale),a(r),T(21956),T(0)])},mt=t=>b("hdlr",0,0,[B("mhlr"),B(t),o(0),o(0),o(0),B("mp4-muxer-hdlr",!0)]),dt=t=>y("minf",null,[t.info.type==="video"?pt():ct(),Tt(),St(t)]),pt=()=>b("vmhd",0,1,[T(0),T(0),T(0),T(0)]),ct=()=>b("smhd",0,0,[T(0),T(0)]),Tt=()=>y("dinf",null,[Ct()]),Ct=()=>b("dref",0,0,[o(1)],[bt()]),bt=()=>b("url ",0,1),St=t=>y("stbl",null,[yt(t),Ot(t),Ut(t),Et(t),_t(t),Dt(t)]),yt=t=>b("stsd",0,0,[o(1)],[t.info.type==="video"?gt(jt[t.info.codec],t):At(Wt[t.info.codec],t)]),gt=(t,e)=>y(t,[Array(6).fill(0),T(1),T(0),T(0),Array(12).fill(0),T(e.info.width),T(e.info.height),o(4718592),o(4718592),o(0),T(1),Array(32).fill(0),T(24),qe(65535)],[$t[e.info.codec](e)]),xt=t=>t.codecPrivate&&y("avcC",[...t.codecPrivate]),wt=t=>t.codecPrivate&&y("hvcC",[...t.codecPrivate]),vt=t=>t.codecPrivate&&y("vpcC",[...t.codecPrivate]),kt=t=>t.codecPrivate&&y("av1C",[...t.codecPrivate]),At=(t,e)=>y(t,[Array(6).fill(0),T(1),T(0),T(0),o(0),T(e.info.numberOfChannels),T(16),T(0),T(0),O(e.info.sampleRate)],[Xt[e.info.codec](e)]),Bt=t=>b("esds",0,0,[o(58753152),k(32+t.codecPrivate.byteLength),T(1),k(0),o(75530368),k(18+t.codecPrivate.byteLength),k(64),k(21),Me(0),o(130071),o(130071),o(92307584),k(t.codecPrivate.byteLength),...t.codecPrivate,o(109084800),k(1),k(2)]),zt=t=>y("dOps",[k(0),k(t.info.numberOfChannels),T(3840),o(t.info.sampleRate),ce(0),k(0)]),Ot=t=>b("stts",0,0,[o(t.timeToSampleTable.length),t.timeToSampleTable.map(e=>[o(e.sampleCount),o(e.sampleDelta)])]),Ut=t=>{if(t.samples.every(i=>i.type==="key"))return null;let e=[...t.samples.entries()].filter(([,i])=>i.type==="key");return b("stss",0,0,[o(e.length),e.map(([i])=>o(i+1))])},Et=t=>b("stsc",0,0,[o(t.compactlyCodedChunkTable.length),t.compactlyCodedChunkTable.map(e=>[o(e.firstChunk),o(e.samplesPerChunk),o(1)])]),_t=t=>b("stsz",0,0,[o(0),o(t.samples.length),t.samples.map(e=>o(e.size))]),Dt=t=>t.finalizedChunks.length>0&&D(t.finalizedChunks).offset>=2**32?b("co64",0,0,[o(t.finalizedChunks.length),t.finalizedChunks.map(e=>M(e.offset))]):b("stco",0,0,[o(t.finalizedChunks.length),t.finalizedChunks.map(e=>o(e.offset))]),It=t=>y("mvex",null,t.map(Pt)),Pt=t=>b("trex",0,0,[o(t.id),o(1),o(0),o(0),o(0)]),Fe=(t,e)=>y("moof",null,[Mt(t),...e.map(Lt)]),Mt=t=>b("mfhd",0,0,[o(t)]),Ye=t=>{let e=0,i=0,r=0,n=0,a=t.type==="delta";return i|=+a,a?e|=1:e|=2,e<<24|i<<16|r<<8|n},Lt=t=>y("traf",null,[Vt(t),Ft(t),Rt(t)]),Vt=t=>{let e=0;e|=8,e|=16,e|=32,e|=131072;let i=t.currentChunk.samples[1]??t.currentChunk.samples[0],r={duration:i.timescaleUnitsToNextSample,size:i.size,flags:Ye(i)};return b("tfhd",0,e,[o(t.id),o(r.duration),o(r.size),o(r.flags)])},Ft=t=>b("tfdt",1,0,[M(E(t.currentChunk.startTimestamp,t.timescale))]),Rt=t=>{let e=t.currentChunk.samples.map(q=>q.timescaleUnitsToNextSample),i=t.currentChunk.samples.map(q=>q.size),r=t.currentChunk.samples.map(Ye),n=new Set(e),a=new Set(i),l=new Set(r),m=l.size===2&&r[0]!==r[1],p=n.size>1,C=a.size>1,A=!m&&l.size>1,P=0;return P|=1,P|=4*+m,P|=256*+p,P|=512*+C,P|=1024*+A,b("trun",0,P,[o(t.currentChunk.samples.length),o(t.currentChunk.offset-t.currentChunk.moofOffset||0),m?o(r[0]):[],t.currentChunk.samples.map((q,De)=>[p?o(e[De]):[],C?o(i[De]):[],A?o(r[De]):[]])])},Ze=t=>y("mfra",null,[...t.map(Nt),Ht()]),Nt=(t,e)=>b("tfra",1,0,[o(t.id),o(63),o(t.finalizedChunks.length),t.finalizedChunks.map(r=>[M(E(r.startTimestamp,t.timescale)),M(r.moofOffset),o(e+1),o(1),o(1)])]),Ht=()=>b("mfro",0,0,[o(0)]),jt={avc:"avc1",hevc:"hvc1",vp9:"vp09",av1:"av01"},$t={avc:xt,hevc:wt,vp9:vt,av1:kt},Wt={aac:"mp4a",opus:"Opus"},Xt={aac:Bt,opus:zt};var be=class{constructor(){this.buffer=null}},K=class{constructor(e){this.options=e}},Se=class{constructor(e,i){this.stream=e;this.options=i}};var L,j,se=class{constructor(){this.pos=0;f(this,L,new Uint8Array(8));f(this,j,new DataView(s(this,L).buffer));this.offsets=new WeakMap}seek(e){this.pos=e}writeU32(e){s(this,j).setUint32(0,e,!1),this.write(s(this,L).subarray(0,4))}writeU64(e){s(this,j).setUint32(0,Math.floor(e/2**32),!1),s(this,j).setUint32(4,e,!1),this.write(s(this,L).subarray(0,8))}writeAscii(e){for(let i=0;i<e.length;i++)s(this,j).setUint8(i%8,e.charCodeAt(i)),i%8===7&&this.write(s(this,L));e.length%8!==0&&this.write(s(this,L).subarray(0,e.length%8))}writeBox(e){if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeBoxHeader(e,e.size??e.contents.byteLength+8),this.write(e.contents);else{let i=this.pos;if(this.writeBoxHeader(e,0),e.contents&&this.write(e.contents),e.children)for(let a of e.children)a&&this.writeBox(a);let r=this.pos,n=e.size??r-i;this.seek(i),this.writeBoxHeader(e,n),this.seek(r)}}writeBoxHeader(e,i){this.writeU32(e.largeSize?1:i),this.writeAscii(e.type),e.largeSize&&this.writeU64(i)}measureBoxHeader(e){return 8+(e.largeSize?8:0)}patchBox(e){let i=this.pos;this.seek(this.offsets.get(e)),this.writeBox(e),this.seek(i)}measureBox(e){if(e.contents&&!e.children)return this.measureBoxHeader(e)+e.contents.byteLength;{let i=this.measureBoxHeader(e);if(e.contents&&(i+=e.contents.byteLength),e.children)for(let r of e.children)r&&(i+=this.measureBox(r));return i}}};L=new WeakMap,j=new WeakMap;var ne,V,Q,Y,ae,Re,ge=class extends se{constructor(i){super();f(this,ae);f(this,ne,void 0);f(this,V,new ArrayBuffer(2**16));f(this,Q,new Uint8Array(s(this,V)));f(this,Y,0);S(this,ne,i)}write(i){d(this,ae,Re).call(this,this.pos+i.byteLength),s(this,Q).set(i,this.pos),this.pos+=i.byteLength,S(this,Y,Math.max(s(this,Y),this.pos))}finalize(){d(this,ae,Re).call(this,this.pos),s(this,ne).buffer=s(this,V).slice(0,Math.max(s(this,Y),this.pos))}};ne=new WeakMap,V=new WeakMap,Q=new WeakMap,Y=new WeakMap,ae=new WeakSet,Re=function(i){let r=s(this,V).byteLength;for(;r<i;)r*=2;if(r===s(this,V).byteLength)return;let n=new ArrayBuffer(r),a=new Uint8Array(n);a.set(s(this,Q),0),S(this,V,n),S(this,Q,a)};var oe,F,ie=class extends se{constructor(i){super();f(this,oe,void 0);f(this,F,[]);S(this,oe,i)}write(i){s(this,F).push({data:i.slice(),start:this.pos}),this.pos+=i.byteLength}flush(){if(s(this,F).length===0)return;let i=[],r=[...s(this,F)].sort((n,a)=>n.start-a.start);i.push({start:r[0].start,size:r[0].data.byteLength});for(let n=1;n<r.length;n++){let a=i[i.length-1],l=r[n];l.start<=a.start+a.size?a.size=Math.max(a.size,l.start+l.data.byteLength-a.start):i.push({start:l.start,size:l.data.byteLength})}for(let n of i){n.data=new Uint8Array(n.size);for(let a of s(this,F))n.start<=a.start&&a.start<n.start+n.size&&n.data.set(a.data,a.start-n.start);s(this,oe).options.onData?.(n.data,n.start)}s(this,F).length=0}finalize(){}};oe=new WeakMap,F=new WeakMap;var qt=2**24,Gt=2,le,z,w,he,Ne,we,Je,ve,et,Z,ye,re=class extends se{constructor(i){super();f(this,he);f(this,we);f(this,ve);f(this,Z);f(this,le,void 0);f(this,z,void 0);f(this,w,[]);if(S(this,le,i),S(this,z,i.options?.chunkSize??qt),!Number.isInteger(s(this,z))||s(this,z)<2**10)throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}write(i){d(this,he,Ne).call(this,i,this.pos),d(this,Z,ye).call(this),this.pos+=i.byteLength}finalize(){d(this,Z,ye).call(this,!0)}};le=new WeakMap,z=new WeakMap,w=new WeakMap,he=new WeakSet,Ne=function(i,r){let n=s(this,w).findIndex(C=>C.start<=r&&r<C.start+s(this,z));n===-1&&(n=d(this,ve,et).call(this,r));let a=s(this,w)[n],l=r-a.start,m=i.subarray(0,Math.min(s(this,z)-l,i.byteLength));a.data.set(m,l);let p={start:l,end:l+m.byteLength};if(d(this,we,Je).call(this,a,p),a.written[0].start===0&&a.written[0].end===s(this,z)&&(a.shouldFlush=!0),s(this,w).length>Gt){for(let C=0;C<s(this,w).length-1;C++)s(this,w)[C].shouldFlush=!0;d(this,Z,ye).call(this)}m.byteLength<i.byteLength&&d(this,he,Ne).call(this,i.subarray(m.byteLength),r+m.byteLength)},we=new WeakSet,Je=function(i,r){let n=0,a=i.written.length-1,l=-1;for(;n<=a;){let m=Math.floor(n+(a-n+1)/2);i.written[m].start<=r.start?(n=m+1,l=m):a=m-1}for(i.written.splice(l+1,0,r),(l===-1||i.written[l].end<r.start)&&l++;l<i.written.length-1&&i.written[l].end>=i.written[l+1].start;)i.written[l].end=Math.max(i.written[l].end,i.written[l+1].end),i.written.splice(l+1,1)},ve=new WeakSet,et=function(i){let n={start:Math.floor(i/s(this,z))*s(this,z),data:new Uint8Array(s(this,z)),written:[],shouldFlush:!1};return s(this,w).push(n),s(this,w).sort((a,l)=>a.start-l.start),s(this,w).indexOf(n)},Z=new WeakSet,ye=function(i=!1){for(let r=0;r<s(this,w).length;r++){let n=s(this,w)[r];if(!(!n.shouldFlush&&!i)){for(let a of n.written)s(this,le).options.onData?.(n.data.subarray(a.start,a.end),n.start+a.start);s(this,w).splice(r--,1)}}};var xe=class extends re{constructor(e){super(new K({onData:(i,r)=>e.stream.write({type:"write",data:i,position:r}),chunkSize:e.options?.chunkSize}))}};var Te=1e3,Kt=["avc","hevc","vp9","av1"],Qt=["aac","opus"],Yt=2082844800,Zt=["strict","offset"],u,h,fe,v,g,x,$,W,Ae,R,N,J,Be,tt,ze,st,Oe,it,Ue,rt,Ee,nt,me,je,U,I,_e,at,ee,ke,de,$e,X,ue,pe,We,He=class{constructor(e){f(this,Be);f(this,ze);f(this,Oe);f(this,Ue);f(this,Ee);f(this,me);f(this,U);f(this,_e);f(this,ee);f(this,de);f(this,X);f(this,pe);f(this,u,void 0);f(this,h,void 0);f(this,fe,void 0);f(this,v,void 0);f(this,g,null);f(this,x,null);f(this,$,Math.floor(Date.now()/1e3)+Yt);f(this,W,[]);f(this,Ae,1);f(this,R,[]);f(this,N,[]);f(this,J,!1);if(d(this,Be,tt).call(this,e),e.video=G(e.video),e.audio=G(e.audio),e.fastStart=G(e.fastStart),this.target=e.target,S(this,u,{firstTimestampBehavior:"strict",...e}),e.target instanceof be)S(this,h,new ge(e.target));else if(e.target instanceof K)S(this,h,e.target.options?.chunked?new re(e.target):new ie(e.target));else if(e.target instanceof Se)S(this,h,new xe(e.target));else throw new Error(`Invalid target: ${e.target}`);d(this,Ue,rt).call(this),d(this,ze,st).call(this)}addVideoChunk(e,i,r){let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addVideoChunkRaw(n,e.type,r??e.timestamp,e.duration,i)}addVideoChunkRaw(e,i,r,n,a){if(d(this,pe,We).call(this),!s(this,u).video)throw new Error("No video track declared.");if(typeof s(this,u).fastStart=="object"&&s(this,g).samples.length===s(this,u).fastStart.expectedVideoChunks)throw new Error(`Cannot add more video chunks than specified in 'fastStart' (${s(this,u).fastStart.expectedVideoChunks}).`);let l=d(this,me,je).call(this,s(this,g),e,i,r,n,a);if(s(this,u).fastStart==="fragmented"&&s(this,x)){for(;s(this,N).length>0&&s(this,N)[0].timestamp<=l.timestamp;){let m=s(this,N).shift();d(this,U,I).call(this,s(this,x),m)}l.timestamp<=s(this,x).lastTimestamp?d(this,U,I).call(this,s(this,g),l):s(this,R).push(l)}else d(this,U,I).call(this,s(this,g),l)}addAudioChunk(e,i,r){let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addAudioChunkRaw(n,e.type,r??e.timestamp,e.duration,i)}addAudioChunkRaw(e,i,r,n,a){if(d(this,pe,We).call(this),!s(this,u).audio)throw new Error("No audio track declared.");if(typeof s(this,u).fastStart=="object"&&s(this,x).samples.length===s(this,u).fastStart.expectedAudioChunks)throw new Error(`Cannot add more audio chunks than specified in 'fastStart' (${s(this,u).fastStart.expectedAudioChunks}).`);let l=d(this,me,je).call(this,s(this,x),e,i,r,n,a);if(s(this,u).fastStart==="fragmented"&&s(this,g)){for(;s(this,R).length>0&&s(this,R)[0].timestamp<=l.timestamp;){let m=s(this,R).shift();d(this,U,I).call(this,s(this,g),m)}l.timestamp<=s(this,g).lastTimestamp?d(this,U,I).call(this,s(this,x),l):s(this,N).push(l)}else d(this,U,I).call(this,s(this,x),l)}finalize(){if(s(this,J))throw new Error("Cannot finalize a muxer more than once.");if(s(this,u).fastStart==="fragmented"){for(let i of s(this,R))d(this,U,I).call(this,s(this,g),i);for(let i of s(this,N))d(this,U,I).call(this,s(this,x),i);d(this,de,$e).call(this,!1)}else s(this,g)&&d(this,ee,ke).call(this,s(this,g)),s(this,x)&&d(this,ee,ke).call(this,s(this,x));let e=[s(this,g),s(this,x)].filter(Boolean);if(s(this,u).fastStart==="in-memory"){let i;for(let n=0;n<2;n++){let a=te(e,s(this,$)),l=s(this,h).measureBox(a);i=s(this,h).measureBox(s(this,v));let m=s(this,h).pos+l+i;for(let p of s(this,W)){p.offset=m;for(let{data:C}of p.samples)m+=C.byteLength,i+=C.byteLength}if(m<2**32)break;i>=2**32&&(s(this,v).largeSize=!0)}let r=te(e,s(this,$));s(this,h).writeBox(r),s(this,v).size=i,s(this,h).writeBox(s(this,v));for(let n of s(this,W))for(let a of n.samples)s(this,h).write(a.data),a.data=null}else if(s(this,u).fastStart==="fragmented"){let i=s(this,h).pos,r=Ze(e);s(this,h).writeBox(r);let n=s(this,h).pos-i;s(this,h).seek(s(this,h).pos-4),s(this,h).writeU32(n)}else{let i=s(this,h).offsets.get(s(this,v)),r=s(this,h).pos-i;s(this,v).size=r,s(this,v).largeSize=r>=2**32,s(this,h).patchBox(s(this,v));let n=te(e,s(this,$));if(typeof s(this,u).fastStart=="object"){s(this,h).seek(s(this,fe)),s(this,h).writeBox(n);let a=i-s(this,h).pos;s(this,h).writeBox(Qe(a))}else s(this,h).writeBox(n)}d(this,X,ue).call(this),s(this,h).finalize(),S(this,J,!0)}};u=new WeakMap,h=new WeakMap,fe=new WeakMap,v=new WeakMap,g=new WeakMap,x=new WeakMap,$=new WeakMap,W=new WeakMap,Ae=new WeakMap,R=new WeakMap,N=new WeakMap,J=new WeakMap,Be=new WeakSet,tt=function(e){if(e.video){if(!Kt.includes(e.video.codec))throw new Error(`Unsupported video codec: ${e.video.codec}`);if(e.video.rotation!==void 0&&![0,90,180,270].includes(e.video.rotation))throw new Error(`Invalid video rotation: ${e.video.rotation}. Has to be 0, 90, 180 or 270.`)}if(e.audio&&!Qt.includes(e.audio.codec))throw new Error(`Unsupported audio codec: ${e.audio.codec}`);if(e.firstTimestampBehavior&&!Zt.includes(e.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`);if(typeof e.fastStart=="object"){if(e.video&&e.fastStart.expectedVideoChunks===void 0)throw new Error("'fastStart' is an object but is missing property 'expectedVideoChunks'.");if(e.audio&&e.fastStart.expectedAudioChunks===void 0)throw new Error("'fastStart' is an object but is missing property 'expectedAudioChunks'.")}else if(![!1,"in-memory","fragmented"].includes(e.fastStart))throw new Error("'fastStart' option must be false, 'in-memory', 'fragmented' or an object.")},ze=new WeakSet,st=function(){if(s(this,h).writeBox(Ke({holdsAvc:s(this,u).video?.codec==="avc",fragmented:s(this,u).fastStart==="fragmented"})),S(this,fe,s(this,h).pos),s(this,u).fastStart==="in-memory")S(this,v,Ce(!1));else if(s(this,u).fastStart!=="fragmented"){if(typeof s(this,u).fastStart=="object"){let e=d(this,Oe,it).call(this);s(this,h).seek(s(this,h).pos+e)}S(this,v,Ce(!0)),s(this,h).writeBox(s(this,v))}d(this,X,ue).call(this)},Oe=new WeakSet,it=function(){if(typeof s(this,u).fastStart!="object")return;let e=0,i=[s(this,u).fastStart.expectedVideoChunks,s(this,u).fastStart.expectedAudioChunks];for(let r of i)r&&(e+=(4+4)*Math.ceil(2/3*r),e+=4*r,e+=(4+4+4)*Math.ceil(2/3*r),e+=4*r,e+=8*r);return e+=4096,e},Ue=new WeakSet,rt=function(){if(s(this,u).video&&S(this,g,{id:1,info:{type:"video",codec:s(this,u).video.codec,width:s(this,u).video.width,height:s(this,u).video.height,rotation:s(this,u).video.rotation??0},timescale:11520,codecPrivate:new Uint8Array(0),samples:[],finalizedChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,lastSample:null,compactlyCodedChunkTable:[]}),s(this,u).audio){let e=d(this,Ee,nt).call(this,2,s(this,u).audio.sampleRate,s(this,u).audio.numberOfChannels);S(this,x,{id:s(this,u).video?2:1,info:{type:"audio",codec:s(this,u).audio.codec,numberOfChannels:s(this,u).audio.numberOfChannels,sampleRate:s(this,u).audio.sampleRate},timescale:s(this,u).audio.sampleRate,codecPrivate:e,samples:[],finalizedChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,lastSample:null,compactlyCodedChunkTable:[]})}},Ee=new WeakSet,nt=function(e,i,r){let a=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350].indexOf(i),l=r,m="";m+=e.toString(2).padStart(5,"0"),m+=a.toString(2).padStart(4,"0"),a===15&&(m+=i.toString(2).padStart(24,"0")),m+=l.toString(2).padStart(4,"0");let p=Math.ceil(m.length/8)*8;m=m.padEnd(p,"0");let C=new Uint8Array(m.length/8);for(let A=0;A<m.length;A+=8)C[A/8]=parseInt(m.slice(A,A+8),2);return C},me=new WeakSet,je=function(e,i,r,n,a,l){let m=n/1e6,p=a/1e6;return m=d(this,_e,at).call(this,m,e),l?.decoderConfig?.description&&(e.codecPrivate=new Uint8Array(l.decoderConfig.description)),{timestamp:m,duration:p,data:i,size:i.byteLength,type:r,timescaleUnitsToNextSample:E(p,e.timescale)}},U=new WeakSet,I=function(e,i){if(s(this,u).fastStart!=="fragmented"&&e.samples.push(i),e.lastTimescaleUnits!==null){let n=E(i.timestamp,e.timescale,!1),a=Math.round(n-e.lastTimescaleUnits);if(e.lastTimescaleUnits+=a,e.lastSample.timescaleUnitsToNextSample=a,s(this,u).fastStart!=="fragmented"){let l=D(e.timeToSampleTable);l.sampleCount===1?(l.sampleDelta=a,l.sampleCount++):l.sampleDelta===a?l.sampleCount++:(l.sampleCount--,e.timeToSampleTable.push({sampleCount:2,sampleDelta:a}))}}else e.lastTimescaleUnits=0,s(this,u).fastStart!=="fragmented"&&e.timeToSampleTable.push({sampleCount:1,sampleDelta:E(i.duration,e.timescale)});e.lastSample=i;let r=!1;if(!e.currentChunk)r=!0;else{let n=i.timestamp-e.currentChunk.startTimestamp;if(s(this,u).fastStart==="fragmented"){let a=s(this,g)??s(this,x);e===a&&i.type==="key"&&n>=1&&(r=!0,d(this,de,$e).call(this))}else r=n>=.5}r&&(e.currentChunk&&d(this,ee,ke).call(this,e),e.currentChunk={startTimestamp:i.timestamp,samples:[]}),e.currentChunk.samples.push(i)},_e=new WeakSet,at=function(e,i){if(s(this,u).firstTimestampBehavior==="strict"&&i.lastTimestamp===-1&&e!==0)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${e}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.

If you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.
`);if(s(this,u).firstTimestampBehavior==="offset"&&(i.firstTimestamp===void 0&&(i.firstTimestamp=e),e-=i.firstTimestamp),e<i.lastTimestamp)throw new Error(`Timestamps must be monotonically increasing (went from ${i.lastTimestamp*1e6} to ${e*1e6}).`);return i.lastTimestamp=e,e},ee=new WeakSet,ke=function(e){if(s(this,u).fastStart==="fragmented")throw new Error("Can't finalize individual chunks 'fastStart' is set to 'fragmented'.");if(e.currentChunk){if(e.finalizedChunks.push(e.currentChunk),s(this,W).push(e.currentChunk),(e.compactlyCodedChunkTable.length===0||D(e.compactlyCodedChunkTable).samplesPerChunk!==e.currentChunk.samples.length)&&e.compactlyCodedChunkTable.push({firstChunk:e.finalizedChunks.length,samplesPerChunk:e.currentChunk.samples.length}),s(this,u).fastStart==="in-memory"){e.currentChunk.offset=0;return}e.currentChunk.offset=s(this,h).pos;for(let i of e.currentChunk.samples)s(this,h).write(i.data),i.data=null;d(this,X,ue).call(this)}},de=new WeakSet,$e=function(e=!0){if(s(this,u).fastStart!=="fragmented")throw new Error("Can't finalize a fragment unless 'fastStart' is set to 'fragmented'.");let i=[s(this,g),s(this,x)].filter(p=>p&&p.currentChunk);if(i.length===0)return;let r=Xe(this,Ae)._++;if(r===1){let p=te(i,s(this,$),!0);s(this,h).writeBox(p)}let n=s(this,h).pos,a=Fe(r,i);s(this,h).writeBox(a);{let p=Ce(!1),C=0;for(let P of i)for(let q of P.currentChunk.samples)C+=q.size;let A=s(this,h).measureBox(p)+C;A>=2**32&&(p.largeSize=!0,A=s(this,h).measureBox(p)+C),p.size=A,s(this,h).writeBox(p)}for(let p of i){p.currentChunk.offset=s(this,h).pos,p.currentChunk.moofOffset=n;for(let C of p.currentChunk.samples)s(this,h).write(C.data),C.data=null}let l=s(this,h).pos;s(this,h).seek(s(this,h).offsets.get(a));let m=Fe(r,i);s(this,h).writeBox(m),s(this,h).seek(l);for(let p of i)p.finalizedChunks.push(p.currentChunk),s(this,W).push(p.currentChunk),p.currentChunk=null;e&&d(this,X,ue).call(this)},X=new WeakSet,ue=function(){s(this,h)instanceof ie&&s(this,h).flush()},pe=new WeakSet,We=function(){if(s(this,J))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};export{be as ArrayBufferTarget,Se as FileSystemWritableFileStreamTarget,He as Muxer,K as StreamTarget};
